<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suret Karta ‚Äî Pixel Board</title>
  <style>
    :root { --grid-w: 100; --grid-h: 100; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; margin:0; }
    header { padding: 12px 16px; background:#111827; color:#fff; display:flex; align-items:center; gap:12px; }
    header h1 { font-size:16px; margin:0; font-weight:600; }
    main { max-width: 920px; margin: 16px auto; padding: 0 16px 32px; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    #controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    #colorPicker { width: 40px; height: 40px; padding:0; border:none; background:transparent; }
    .btn { padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .hint { color:#6b7280; font-size:13px; }
    .canvas-wrap { margin-top:12px; display:flex; justify-content:center; }
    canvas { image-rendering: pixelated; border:1px solid #e5e7eb; background:#ffffff; cursor: crosshair; }
    /* –ö”©—Ä—ñ–Ω—ñ—Å “Ø—à—ñ–Ω canvas-—Ç—ã “Ø–ª–∫–µ–π—Ç–µ–º—ñ–∑, –±—ñ—Ä–∞“õ –ª–æ–≥–∏–∫–∞–ª—ã“õ ”©–ª—à–µ–º ‚Äî grid */
    #board { width: 800px; height: 800px; /* CSS –º–∞—Å—à—Ç–∞–± */ }
  </style>
</head>
<body>
  <header>
    <h1>Suret Karta ‚Äî Pixel Board</h1>
  </header>

  <main>
    <div class="panel">
      <div id="controls">
        <label>–¢“Ø—Å:
          <input type="color" id="colorPicker" value="#000000" title="–¢“Ø—Å —Ç–∞“£–¥–∞“£—ã–∑" />
        </label>
        <button id="eraser" class="btn" title="”®—à—ñ—Ä—É (–∞“õ —Ç“Ø—Å)">”®—à—ñ—Ä–≥—ñ—à</button>
        <button id="clearLocal" class="btn" title="–≠–∫—Ä–∞–Ω–¥—ã –∞“õ–ø–µ–Ω —Ç–æ–ª—Ç—ã—Ä—É (—Ç–µ–∫ –∫”©—Ä—ñ–Ω—ñ—Å)">–≠–∫—Ä–∞–Ω–¥—ã –∂–∞“£–∞—Ä—Ç—É</button>
        <span class="hint">–ö–µ“£–µ—Å: —Ç—ã—à“õ–∞–Ω–¥—ã –±–∞—Å—ã–ø —Ç“±—Ä—ã–ø –±–æ—è—Å–∞“£—ã–∑ ‚Äî —Ç–µ–∑—ñ—Ä–µ–∫ –±–æ–ª–∞–¥—ã.</span>
      </div>

      <div class="canvas-wrap">
        <!-- –õ–æ–≥–∏–∫–∞–ª—ã“õ ”©–ª—à–µ–º: 100x100 “±—è—à—ã“õ. CSS-–ø–µ–Ω “Ø–ª–∫–µ–π—Ç—ñ–ª–µ–¥—ñ -->
        <canvas id="board" width="100" height="100"></canvas>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üü¢ ”®–∑ –∂–æ–±–∞“£—ã–∑–¥—ã“£ –º”ô–Ω–¥–µ—Ä—ñ–Ω “õ–æ–π—ã“£—ã–∑
    const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // –ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä
    const GRID_W = 100;
    const GRID_H = 100;

    // DOM
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("colorPicker");
    const eraserBtn = document.getElementById("eraser");
    const clearLocalBtn = document.getElementById("clearLocal");

    // –ò–Ω–∏—Ü–∏–∞–ª: –∞“õ —Ñ–æ–Ω
    function initEmptyBoard() {
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, GRID_W, GRID_H);
    }

    // “∞—è—à—ã“õ –±–æ—è—É
    function drawPixel(x, y, color) {
      if (x < 0 || y < 0 || x >= GRID_W || y >= GRID_H) return;
      ctx.fillStyle = color;
      ctx.fillRect(x, y, 1, 1);
    }

    // Database-—Ç–µ–Ω –±–∞—Ä–ª—ã“õ –ø–∏–∫—Å–µ–ª—å–¥—ñ –∂“Ø–∫—Ç–µ—É
    async function loadAll() {
      initEmptyBoard();
      const { data, error } = await supabase.from("pixels").select("x,y,color");
      if (error) {
        console.error("Load error:", error);
        return;
      }
      data.forEach(p => drawPixel(p.x, p.y, p.color));
    }

    // –†–µ–∞–ª—Ç–∞–π–º: INSERT –∂”ô–Ω–µ UPDATE
    function subscribeRealtime() {
      supabase
        .channel("pixels-stream")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "pixels" }, (payload) => {
          const p = payload.new;
          drawPixel(p.x, p.y, p.color);
        })
        .on("postgres_changes", { event: "UPDATE", schema: "public", table: "pixels" }, (payload) => {
          const p = payload.new;
          drawPixel(p.x, p.y, p.color);
        })
        .subscribe((status) => {
          // console.log("Realtime status:", status);
        });
    }

    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –µ—Å–µ–ø—Ç–µ—É (CSS –º–∞—Å—à—Ç–∞–±—ã–Ω –µ—Å–∫–µ—Ä—ñ–ø)
    function clientToGrid(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX);
      const y = Math.floor((e.clientY - rect.top) * scaleY);
      return { x, y };
    }

    // –ë—ñ—Ä “±—è—à—ã“õ—Ç—ã —Å–∞–ª—É (DB-–≥–µ upsert, unique(x,y) –∫–µ—Ä–µ–∫)
    let busy = false;
    async function paintAt(x, y, color) {
      if (busy) return; // “õ–∞—Ä–∞–ø–∞–π—ã–º “õ–æ—Ä“ì–∞–Ω—ã—Å, —à–∞–º–∞–¥–∞–Ω —Ç—ã—Å —Å“±—Ä–∞–Ω—ã—Å—Ç—ã –∞–∑–∞–π—Ç—É
      busy = true;
      try {
        // upsert: –±–∞—Ä –±–æ–ª—Å–∞ ‚Äî –∂–∞“£–∞—Ä—Ç–∞–¥—ã, –∂–æ“õ –±–æ–ª—Å–∞ ‚Äî “õ–æ—Å–∞–¥—ã
        const { error } = await supabase
          .from("pixels")
          .upsert({ x, y, color }, { onConflict: "x,y" });
        if (error) console.error("Upsert error:", error);
        // –õ–æ–∫–∞–ª–¥–∞ –±—ñ—Ä–¥–µ–Ω —Å–∞–ª–∞–º—ã–∑ (—Ä–µ–∞–ª—Ç–∞–π–º–¥—ã –∫“Ø—Ç–ø–µ–π)
        drawPixel(x, y, color);
      } finally {
        // —à–∞“ì—ã–Ω –∫—ñ–¥—ñ—Ä—ñ—Å ‚Äî —Ç—ã–º –∂–∏—ñ –∂–∞–∑—É–¥—ã –∞–∑–∞–π—Ç—É
        setTimeout(() => (busy = false), 8);
      }
    }

    // Mouse drawing
    let isDown = false;
    let currentColor = colorPicker.value;

    colorPicker.addEventListener("input", () => {
      currentColor = colorPicker.value;
    });

    eraserBtn.addEventListener("click", () => {
      currentColor = "#ffffff"; // ”©—à—ñ—Ä–≥—ñ—à ‚Äî –∞“õ —Ç“Ø—Å
      colorPicker.value = "#ffffff";
    });

    clearLocalBtn.addEventListener("click", () => {
      initEmptyBoard(); // —Ç–µ–∫ —ç–∫—Ä–∞–Ω–¥—ã —Ç–∞–∑–∞—Ä—Ç–∞–¥—ã (DB-–Ω—ñ —Ç–∞–∑–∞–ª–∞–º–∞–π–¥—ã)
      loadAll();        // DB-–¥–µ–≥—ñ –±–∞—Ä –ø–∏–∫—Å–µ–ª—å–¥–µ—Ä–¥—ñ “õ–∞–π—Ç–∞ —Å–∞–ª–∞–¥—ã
    });

    canvas.addEventListener("mousedown", (e) => {
      isDown = true;
      const { x, y } = clientToGrid(e);
      paintAt(x, y, currentColor);
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!isDown) return;
      const { x, y } = clientToGrid(e);
      paintAt(x, y, currentColor);
    });

    window.addEventListener("mouseup", () => { isDown = false; });

    // –ë–∞—Å—Ç–∞—É
    await loadAll();
    subscribeRealtime();
  </script>
</body>
</html>
